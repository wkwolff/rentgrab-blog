---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import NewsletterSignup from '@/components/NewsletterSignup.astro';

// Get all posts
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

// Count tags
const tagCounts = new Map();
allPosts.forEach(post => {
  post.data.tags.forEach(tag => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  });
});

// Sort tags by count (most used first)
const sortedTags = Array.from(tagCounts.entries())
  .sort((a, b) => b[1] - a[1]);

// Format tag name for display
function formatTagName(tag) {
  return tag
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}
---

<BaseLayout
  title="All Tags | RentGrab Blog"
  description="Browse all tags and topics covered on the RentGrab blog."
>
  <!-- Hero Section -->
  <section class="bg-gradient-to-b from-primary-50 to-white py-12 lg:py-16">
    <div class="container-lg">
      <div class="flex items-center gap-4 mb-4">
        <a href="/blog" class="text-primary-500 hover:text-primary-600 transition-colors">
          ‚Üê Back to Blog
        </a>
      </div>
      <div class="text-center">
        <h1 class="text-hero mb-4">All Tags</h1>
        <p class="text-xl text-neutral-600 max-w-3xl mx-auto">
          Explore our content by topic. Click any tag to see related articles.
        </p>
      </div>
    </div>
  </section>

  <!-- Tags Cloud -->
  <section class="container-lg py-12">
    <div class="max-w-4xl mx-auto">
      <div class="flex flex-wrap gap-3 justify-center">
        {sortedTags.map(([tag, count]) => {
          // Calculate size based on usage (min 1rem, max 1.5rem)
          const maxCount = Math.max(...tagCounts.values());
          const minCount = Math.min(...tagCounts.values());
          const sizeScale = minCount === maxCount ? 1 : (count - minCount) / (maxCount - minCount);
          const fontSize = 0.875 + (sizeScale * 0.375); // 0.875rem to 1.25rem
          
          return (
            <a
              href={`/blog/tag/${tag}`}
              class="inline-flex items-center gap-2 px-4 py-2 bg-primary-50 text-primary-700 rounded-full hover:bg-primary-100 transition-colors"
              style={`font-size: ${fontSize}rem;`}
            >
              <span>{formatTagName(tag)}</span>
              <span class="text-xs bg-white text-primary-600 px-2 py-0.5 rounded-full">
                {count}
              </span>
            </a>
          );
        })}
      </div>
    </div>
  </section>

  <!-- Popular Tags Section -->
  <section class="container-lg py-12 border-t border-neutral-200">
    <h2 class="text-h2 text-center mb-8">Popular Topics</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto">
      {sortedTags.slice(0, 6).map(([tag, count]) => (
        <a
          href={`/blog/tag/${tag}`}
          class="p-6 bg-white rounded-lg border border-neutral-200 hover:border-primary-500 hover:shadow-sm transition-all group"
        >
          <h3 class="text-lg font-semibold text-neutral-900 group-hover:text-primary-500 mb-2">
            {formatTagName(tag)}
          </h3>
          <p class="text-neutral-600">
            {count} {count === 1 ? 'article' : 'articles'}
          </p>
        </a>
      ))}
    </div>
  </section>

  <!-- Newsletter -->
  <NewsletterSignup 
    location="tags-page-bottom"
    title="Never Miss a Post"
    description="Subscribe to get the latest articles on your favorite topics delivered to your inbox."
  />
</BaseLayout>